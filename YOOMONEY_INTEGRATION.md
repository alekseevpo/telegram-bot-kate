# üí≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ÆMoney (YooKassa) - –ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ÆKassa](#1-—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è-–≤-—ékassa)
2. [–ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–µ–π](#2-–ø–æ–ª—É—á–µ–Ω–∏–µ-api-–∫–ª—é—á–µ–π)
3. [–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Bot](#3-–Ω–∞—Å—Ç—Ä–æ–π–∫–∞-telegram-bot)
4. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∫–æ–¥](#4-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-–≤-–∫–æ–¥)
5. [–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ](#5-—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
6. [Production –¥–µ–ø–ª–æ–π](#6-production-–¥–µ–ø–ª–æ–π)
7. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#7-–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
8. [–ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã](#8-—á–∞—Å—Ç—ã–µ-–ø—Ä–æ–±–ª–µ–º—ã)

---

## 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –ÆKassa

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ [yookassa.ru](https://yookassa.ru)
2. –ù–∞–∂–º–∏—Ç–µ **"–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"**
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:
   - **–ò–ü / –û–û–û** - –¥–ª—è –±–∏–∑–Ω–µ—Å–∞
   - **–°–∞–º–æ–∑–∞–Ω—è—Ç—ã–π** - —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

### –®–∞–≥ 2: –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö

**–î–ª—è —Å–∞–º–æ–∑–∞–Ω—è—Ç—ã—Ö:**
- –ò–ù–ù
- –§–ò–û
- –¢–µ–ª–µ—Ñ–æ–Ω
- Email
- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã

**–î–ª—è –ò–ü/–û–û–û:**
- –í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
- –û–ì–†–ù/–û–ì–†–ù–ò–ü
- –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã
- –£—Å—Ç–∞–≤ (–¥–ª—è –û–û–û)

### –®–∞–≥ 3: –í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (SMS)
- –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ (1-3 –¥–Ω—è)

### –®–∞–≥ 4: –°–æ–∑–¥–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞

1. –ü–æ—Å–ª–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤–æ–π–¥–∏—Ç–µ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
2. **–ú–∞–≥–∞–∑–∏–Ω—ã** ‚Üí **–°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω**
3. –£–∫–∞–∂–∏—Ç–µ:
   - –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞: "–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ - –ö—Ä–∏–∑–∏—Å–Ω—ã–π —Ü–µ–ª–∏—Ç–µ–ª—å"
   - URL —Å–∞–π—Ç–∞: `https://your-site.vercel.app`
   - –û–ø–∏—Å–∞–Ω–∏–µ: "–ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —É—Å–ª—É–≥–∏ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏"
   - –ö–∞—Ç–µ–≥–æ—Ä–∏—è: "–£—Å–ª—É–≥–∏"

---

## 2. –ü–æ–ª—É—á–µ–Ω–∏–µ API –∫–ª—é—á–µ–π

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa

1. –í–æ–π–¥–∏—Ç–µ –Ω–∞ [yookassa.ru/my](https://yookassa.ru/my)
2. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –º–∞–≥–∞–∑–∏–Ω
3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**
4. –ù–∞–π–¥–∏—Ç–µ —Ä–∞–∑–¥–µ–ª **"–ö–ª—é—á–∏ –¥–ª—è API"**

### –°–ø–æ—Å–æ–± 2: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è** ‚Üí **API-–∫–ª—é—á–∏**
2. –ù–∞–∂–º–∏—Ç–µ **"–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á"**
3. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É:
   ```
   –ù–∞–∑–≤–∞–Ω–∏–µ: Telegram Bot Kate
   –ü—Ä–∞–≤–∞: ‚úÖ –ü—Ä–æ–≤–µ–¥–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π
          ‚úÖ –í–æ–∑–≤—Ä–∞—Ç—ã
          ‚úÖ –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
   ```
4. –ù–∞–∂–º–∏—Ç–µ **"–°–æ–∑–¥–∞—Ç—å"**

### –ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ:

```
shopId: 123456
–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á: live_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

‚ö†Ô∏è **–í–ê–ñ–ù–û:** –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è **—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑**! –°—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –µ–≥–æ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ –º–µ—Å—Ç–æ.

### –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)

1. –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –Ω–∞ **"–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º"**
2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å `test_`)
3. –¢–µ—Å—Ç–æ–≤—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –Ω–µ —Å–ø–∏—Å—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–µ–Ω—å–≥–∏

```
# –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
shopId: 123456
–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á: test_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

---

## 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Bot

### –®–∞–≥ 1: –û—Ç–∫—Ä—ã—Ç—å BotFather

1. –û—Ç–∫—Ä–æ–π—Ç–µ Telegram
2. –ù–∞–π–¥–∏—Ç–µ [@BotFather](https://t.me/BotFather)
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É: `/mybots`

### –®–∞–≥ 2: –í—ã–±—Ä–∞—Ç—å –±–æ—Ç–∞

1. –í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
2. –ù–∞–∂–º–∏—Ç–µ **"Payments"**

### –®–∞–≥ 3: –ü–æ–¥–∫–ª—é—á–∏—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

1. –í—ã–±–µ—Ä–∏—Ç–µ **"YooMoney"** –∏–ª–∏ **"–ÆKassa"**
2. –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ:
   ```
   Shop ID: [–í–∞—à shopId –∏–∑ –ÆKassa]
   Secret Key: [–í–∞—à —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ –ÆKassa]
   ```
3. –ù–∞–∂–º–∏—Ç–µ **"Connect"**

### –®–∞–≥ 4: –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω

BotFather –≤–µ—Ä–Ω–µ—Ç –≤–∞–º **Payment Provider Token**:

```
‚úÖ Your payment provider has been connected.
Token: 381764678:LIVE:xxxxxxxxxxxxxxxxxxxxx
```

‚ö†Ô∏è **–°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω!** –û–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞.

---

## 4. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –∫–æ–¥

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å `.env`

–°–æ–∑–¥–∞–π—Ç–µ/–æ–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
# Telegram Bot
BOT_TOKEN=your_bot_token_from_botfather
ADMIN_ID=your_telegram_id

# YooKassa / –ÆMoney
YOOKASSA_SHOP_ID=123456
YOOKASSA_SECRET_KEY=live_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
PAYMENT_PROVIDER_TOKEN=381764678:LIVE:xxxxxxxxxxxxxxxxxxxxx

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
CURRENCY=RUB
MIN_PAYMENT_AMOUNT=100
MAX_PAYMENT_AMOUNT=999999
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç—å `config.py`

```python
import os
from dotenv import load_dotenv

load_dotenv()

# Telegram
BOT_TOKEN = os.getenv('BOT_TOKEN')
ADMIN_ID = int(os.getenv('ADMIN_ID', 0))

# –ü–ª–∞—Ç–µ–∂–∏
PAYMENT_PROVIDER_TOKEN = os.getenv('PAYMENT_PROVIDER_TOKEN')
YOOKASSA_SHOP_ID = os.getenv('YOOKASSA_SHOP_ID')
YOOKASSA_SECRET_KEY = os.getenv('YOOKASSA_SECRET_KEY')
CURRENCY = os.getenv('CURRENCY', 'RUB')

# –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
if not PAYMENT_PROVIDER_TOKEN:
    raise ValueError("‚ùå PAYMENT_PROVIDER_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ .env!")

if not YOOKASSA_SHOP_ID or not YOOKASSA_SECRET_KEY:
    print("‚ö†Ô∏è YooKassa –∫–ª—é—á–∏ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã. –ü–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ API –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.")
```

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å `payments.py`

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª `payments.py` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:

```python
import logging
from telegram import LabeledPrice
from config import PAYMENT_PROVIDER_TOKEN, CURRENCY

logger = logging.getLogger(__name__)

class PaymentHandler:
    def __init__(self, db):
        self.db = db
        self.provider_token = PAYMENT_PROVIDER_TOKEN
        self.currency = CURRENCY
    
    async def send_invoice(self, update, context, product):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ –∏–Ω–≤–æ–π—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é"""
        try:
            # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É –≤ –∫–æ–ø–µ–π–∫–∏ (–¥–ª—è —Ä—É–±–ª–µ–π)
            amount = int(product['price'] * 100)
            
            # –°–æ–∑–¥–∞–µ–º –∏–Ω–≤–æ–π—Å
            await context.bot.send_invoice(
                chat_id=update.effective_chat.id,
                title=product['name'],
                description=product['description'],
                payload=f"product_{product['id']}",
                provider_token=self.provider_token,
                currency=self.currency,
                prices=[LabeledPrice(label=product['name'], amount=amount)],
                start_parameter=f"product-{product['id']}"
            )
            
            logger.info(f"–ò–Ω–≤–æ–π—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: product_id={product['id']}")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏–Ω–≤–æ–π—Å–∞: {e}")
            await update.message.reply_text(
                "‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
            )
    
    async def pre_checkout_query(self, update, context):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ–ø–ª–∞—Ç–æ–π"""
        query = update.pre_checkout_query
        
        try:
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
            await query.answer(ok=True)
            logger.info(f"Pre-checkout OK: user={query.from_user.id}")
            
        except Exception as e:
            logger.error(f"Pre-checkout error: {e}")
            await query.answer(
                ok=False,
                error_message="–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–∞"
            )
    
    async def successful_payment(self, update, context):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞"""
        payment = update.message.successful_payment
        user_id = update.effective_user.id
        
        try:
            # –ò–∑–≤–ª–µ–∫–∞–µ–º product_id –∏–∑ payload
            product_id = int(payment.invoice_payload.split('_')[1])
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–∫–∞–∑ –≤ –ë–î
            order_id = self.db.add_order(
                user_id=user_id,
                product_id=product_id,
                amount=payment.total_amount // 100,  # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –∏–∑ –∫–æ–ø–µ–µ–∫
                currency=payment.currency,
                telegram_payment_charge_id=payment.telegram_payment_charge_id,
                provider_payment_charge_id=payment.provider_payment_charge_id
            )
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            product = self.db.get_product(product_id)
            await update.message.reply_text(
                f"‚úÖ –û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞!\n\n"
                f"üì¶ –¢–æ–≤–∞—Ä: {product['name']}\n"
                f"üí∞ –°—É–º–º–∞: {payment.total_amount // 100} {payment.currency}\n"
                f"üÜî –ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞: #{order_id}\n\n"
                f"–°–ø–∞—Å–∏–±–æ –∑–∞ –ø–æ–∫—É–ø–∫—É! üôè"
            )
            
            logger.info(f"–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω: order_id={order_id}, user={user_id}")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞: {e}")
            await update.message.reply_text(
                "‚ö†Ô∏è –ü–ª–∞—Ç–µ–∂ –ø–æ–ª—É—á–µ–Ω, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ. "
                "–°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π."
            )
```

### –®–∞–≥ 4: –û–±–Ω–æ–≤–∏—Ç—å `bot.py`

–î–æ–±–∞–≤—å—Ç–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π:

```python
from telegram.ext import PreCheckoutQueryHandler, MessageHandler, filters
from payments import PaymentHandler

class TelegramBot:
    def __init__(self):
        # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ...
        self.payment_handler = PaymentHandler(self.db)
    
    def setup_handlers(self):
        # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã ...
        
        # –•–µ–Ω–¥–ª–µ—Ä—ã –ø–ª–∞—Ç–µ–∂–µ–π
        self.application.add_handler(
            PreCheckoutQueryHandler(self.payment_handler.pre_checkout_query)
        )
        self.application.add_handler(
            MessageHandler(
                filters.SUCCESSFUL_PAYMENT,
                self.payment_handler.successful_payment
            )
        )
```

### –®–∞–≥ 5: –û–±–Ω–æ–≤–∏—Ç—å `handlers.py`

–î–æ–±–∞–≤—å—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã:

```python
async def handle_product_selection(self, update, context, product_id):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–ª—è –ø–æ–∫—É–ø–∫–∏"""
    product = self.db.get_product(product_id)
    
    if not product:
        await update.callback_query.answer("‚ùå –ü—Ä–æ–¥—É–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω–≤–æ–π—Å —á–µ—Ä–µ–∑ PaymentHandler
    await context.bot_data['payment_handler'].send_invoice(
        update, context, product
    )
    
    await update.callback_query.answer("üìÑ –ò–Ω–≤–æ–π—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!")
```

---

## 5. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ YooKassa

**–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (—É—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞):**
```
–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: 5555 5555 5555 4477
–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 12/24 (–ª—é–±–∞—è –±—É–¥—É—â–∞—è –¥–∞—Ç–∞)
CVC: 123
3D-Secure: 12345 (–µ—Å–ª–∏ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è)
```

**–¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞ (–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ):**
```
–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: 5555 5555 5555 5599
–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: 12/24
CVC: 123
```

### –°—Ü–µ–Ω–∞—Ä–∏–π —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞:**
   ```bash
   python bot.py
   ```

2. **–û—Ç–∫—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –≤ Telegram**

3. **–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç:**
   - `/start`
   - "–ü—Ä–æ–¥—É–∫—Ç—ã"
   - –í—ã–±–µ—Ä–∏—Ç–µ –ª—é–±–æ–π –ø—Ä–æ–¥—É–∫—Ç
   - –ù–∞–∂–º–∏—Ç–µ "–ö—É–ø–∏—Ç—å"

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–≤–æ–π—Å:**
   - –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –ø–ª–∞—Ç–µ–∂–Ω—ã–π –∏–Ω–≤–æ–π—Å
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—É–º–º—É, –Ω–∞–∑–≤–∞–Ω–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ

5. **–û–ø–ª–∞—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π:**
   - –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç—ã
   - –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –æ–ø–ª–∞—Ç—É

6. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –î–æ–ª–∂–Ω–æ –ø—Ä–∏–π—Ç–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã
   - –ó–∞–∫–∞–∑ –¥–æ–ª–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –ë–î
   - –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

```bash
# –°–º–æ—Ç—Ä–∏–º –ª–æ–≥–∏ –±–æ—Ç–∞
tail -f bot.log

# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å:
# INFO - –ò–Ω–≤–æ–π—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: product_id=1
# INFO - Pre-checkout OK: user=123456
# INFO - –ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–µ–Ω: order_id=1, user=123456
```

---

## 6. Production –¥–µ–ø–ª–æ–π

### Render (Backend + Bot)

1. **–û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ Render:**
   ```
   PAYMENT_PROVIDER_TOKEN=381764678:LIVE:xxxxx
   YOOKASSA_SHOP_ID=123456
   YOOKASSA_SECRET_KEY=live_xxxxx
   ```

2. **–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ –ÆKassa –≤ –±–æ–µ–≤–æ–π —Ä–µ–∂–∏–º:**
   - –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏
   - –í—ã–∫–ª—é—á–∏—Ç–µ "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º"
   - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `live_` –∫–ª—é—á–∏

3. **–î–µ–ø–ª–æ–π:**
   ```bash
   git add .
   git commit -m "‚ú® Add YooKassa integration"
   git push origin main
   ```

### Vercel (Frontend)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å frontend –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π:

```bash
cd web-admin
npm run build
vercel --prod
```

---

## 7. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- [ ] –¢–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `.env` (–Ω–µ –≤ –∫–æ–¥–µ!)
- [ ] `.env` –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore`
- [ ] HTTPS –≤–∫–ª—é—á–µ–Ω –Ω–∞ –≤—Å–µ—Ö –¥–æ–º–µ–Ω–∞—Ö
- [ ] –í–∞–ª–∏–¥–∞—Ü–∏—è —Å—É–º–º –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- [ ] –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ë–î —Å –∑–∞–∫–∞–∑–∞–º–∏

### –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

```python
# payments.py
def validate_payment_amount(amount: float, product_id: int) -> bool:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É–º–º—ã –ø–ª–∞—Ç–µ–∂–∞"""
    product = db.get_product(product_id)
    expected_amount = product['price'] * 100  # –≤ –∫–æ–ø–µ–π–∫–∞—Ö
    
    if amount != expected_amount:
        logger.warning(
            f"‚ö†Ô∏è –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—É–º–º—ã: "
            f"expected={expected_amount}, received={amount}"
        )
        return False
    
    return True
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```python
# –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∞–¥–º–∏–Ω—É –æ –ø–ª–∞—Ç–µ–∂–∞—Ö
async def notify_admin_payment(order_id, user_id, amount):
    admin_message = (
        f"üí∞ –ù–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂!\n\n"
        f"üÜî –ó–∞–∫–∞–∑: #{order_id}\n"
        f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}\n"
        f"üíµ –°—É–º–º–∞: {amount} RUB"
    )
    await context.bot.send_message(ADMIN_ID, admin_message)
```

---

## 8. –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### ‚ùå "Payment_provider_invalid"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ `.env`
2. –ü–æ–ª—É—á–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω —É @BotFather
3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ç–æ–∫–µ–Ω –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞

### ‚ùå "Can't parse labeled price: field 'amount' must be a valid number"

**–ü—Ä–∏—á–∏–Ω–∞:** –°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º –≤ –∫–æ–ø–µ–π–∫–∞—Ö.

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ
amount = product['price'] * 100  # 5000.0

# –ü—Ä–∞–≤–∏–ª—å–Ω–æ
amount = int(product['price'] * 100)  # 500000
```

### ‚ùå "Shop not found"

**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π `shopId` –∏–ª–∏ –º–∞–≥–∞–∑–∏–Ω –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `shopId` –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –ÆKassa
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –º–∞–≥–∞–∑–∏–Ω –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–µ–∂–∏–º (—Ç–µ—Å—Ç/–ø—Ä–æ–¥)

### ‚ùå –ü–ª–∞—Ç–µ–∂ –ø—Ä–æ—Ö–æ–¥–∏—Ç, –Ω–æ –∑–∞–∫–∞–∑ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω–∞:** –û—à–∏–±–∫–∞ –≤ `successful_payment` —Ö–µ–Ω–¥–ª–µ—Ä–µ.

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `tail -f bot.log`
2. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `payload` –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–∞—Ä—Å–∏—Ç—Å—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `add_order` –º–µ—Ç–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç

### ‚ùå "Insufficient funds" –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–µ

**–ü—Ä–∏—á–∏–Ω–∞:** –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –Ω–µ –≤–∫–ª—é—á–µ–Ω –≤ –ÆKassa.

**–†–µ—à–µ–Ω–∏–µ:**
1. –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ÆKassa ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏
2. –í–∫–ª—é—á–∏—Ç–µ "–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º"
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –∫–ª—é—á–∏ (`test_`)

---

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –ÆKassa
- **Email:** support@yookassa.ru
- **–¢–µ–ª–µ—Ñ–æ–Ω:** 8 800 250-66-99
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [yookassa.ru/developers](https://yookassa.ru/developers)

### Telegram Bot API
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** [core.telegram.org/bots/payments](https://core.telegram.org/bots/payments)
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞:** [@BotSupport](https://t.me/BotSupport)

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

- [ ] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∞–∫–∫–∞—É–Ω—Ç –≤ –ÆKassa
- [ ] –°–æ–∑–¥–∞–Ω –º–∞–≥–∞–∑–∏–Ω
- [ ] –ü–æ–ª—É—á–µ–Ω—ã `shopId` –∏ `secretKey`
- [ ] –ü–æ–¥–∫–ª—é—á–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä –≤ @BotFather
- [ ] –ü–æ–ª—É—á–µ–Ω `PAYMENT_PROVIDER_TOKEN`
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω `.env` —Ñ–∞–π–ª
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω `config.py`
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω —Ç–µ—Å—Ç–æ–≤–æ–π –∫–∞—Ä—Ç–æ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω—ã –ª–æ–≥–∏
- [ ] –ó–∞–¥–µ–ø–ª–æ–µ–Ω –≤ production
- [ ] –ù–∞—Å—Ç—Ä–æ–µ–Ω –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
- [ ] –ü—Ä–æ–≤–µ–¥–µ–Ω–∞ –ø–µ—Ä–≤–∞—è —Ä–µ–∞–ª—å–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è

---

**üéâ –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –≤–∞—à –±–æ—Ç –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏ —á–µ—Ä–µ–∑ –ÆMoney!**

üí° **–°–æ–≤–µ—Ç:** –ù–∞—á–Ω–∏—Ç–µ —Å —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞, —É–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏ —Ç–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏.

